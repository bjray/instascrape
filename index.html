<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>JNA - Instagram Test Scrape</title>
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="stylesheets/base.css">
	<link rel="stylesheet" href="stylesheets/skeleton.css">
	<link rel="stylesheet" href="stylesheets/layout.css">

	<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>

	<!-- Favicons
	================================================== -->
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

</head>
<body>



	<!-- Primary Page Layout
	================================================== -->

	<!-- Delete everything in this .container and get started on your own site! -->

	<div class="container">
		<div class="two columns">
			<img src="./images/round-logo.png" alt="" />
		</div>
		<div class="fourteen columns">
			<h1 class="remove-bottom jna">JNA: Instagram Scrapper</h1>
			<div style="margin-top: 10px">
				<h5 class="left">Version 0.3</h5><div class="right" id="tokenLabel">using token: </div>
			</div>
		</div>
		<hr />
		<div class="one-third column">
			<h5 class="jna">Select an Instagram User:</h5>
			<div id="userSearchContainer">
				<input type="text" name="userName" id="userName" placeholder="Instagram user name..." />
				<a href="#" class="button prefix" id="searchUser">Search</a>
			</div>
		</div>
		<div class="one-third column">
			<span id="foundUser" class="insta"></span>
			<span id="foundId" class="insta"></span>
			<div id="mediaSearch" class="insta"></div>
		</div>
		<div class="one-third column insta" id="foundImg">
		</div>
		<hr />
		<div class="twelve columns">
			<div id="panel" class="insta"></div>
		</div>
		<div class="four columns">
			<div id="mediaComments" class="insta small" ></div>
		</div>
		<div class="sixteen columns" id="footer">
		</div>
		
	</div><!-- container -->
	<div class="modal"><!-- Place at bottom of page --></div>
<!-- End Document
================================================== -->
<!-- Script
================================================== -->
<script>   
   $(document).ready(function() {
   	
   	//initializing variables...
   	var access_token = '23196669.1fb234f.bc3cae7446e549e0907701de12888236';
   	
   	
   	//initialize controls...
   	$("#tokenLabel").append("<span class=\"radius secondary label\">" + access_token + "</span>");

   	$("#searchUser").click(function() {
   		var userName = $("#userName").val();
//   	  $( "#searchProgressBar" ).progressbar( "option", "value", false );
			if (userName.length == 0) {
				$("#foundUser").append("<span class=\"round alert label\">User Name Invalid</span>");
			} else {
				clearContent();
				searchForUser(userName);
			}
   	});
   	
   	$("body").on({
   	    ajaxStart: function() { 
   	        $(this).addClass("loading"); 
   	    },
   	    ajaxStop: function() { 
   	        $(this).removeClass("loading"); 
   	    }    
   	});
   	
   	
   	//start method declarations...
   	function clearContent() {
   		$('.insta').each(function() {
   			$(this).empty();
   		});
   	}
   	
   	function toggleWait(selector) {
   		$("div id=\"progressbar\"").appendTo(selector);
   	}
   	
   	function searchForUser(userName) {
   		//TODO: add this to screen and then fade when callback occurs...
   		
   		var params = {q:userName, access_token:access_token};
   		findUser(params, onUserFound);
   	}
   	
   	function findUser(params, callback) {
   		var cmdUrl = 'https://api.instagram.com/v1/users/search?callback=?';
   		$.getJSON(cmdUrl, params, callback);
   	}
   	   	
   	
   	function onUserFound(data) {
   		if(data.meta.code == 200) {
   			var users = data.data;
   			if(users.length > 0) {
   				var user = users[0];
   				$("#foundUser").append("<strong>User</strong>: " + user.username);
   				$("#foundId").append("(<strong>Id</strong>: " + user.id + ")");
   				$("#mediaSearch").append("<a href=\"#\" class=\"button prefix\" id=\"recentMedia\">Get Recent Media</a>");
   				
   				$("#recentMedia").click(function() {
   					getRecentMedia(user.id);
   				});
   				
   				$("#foundImg").append("<img src=\"" + user.profile_picture + "\">");
   			} else {
   				$("<span class=\"round alert label\">User Not Found</span>").appendTo("#foundUser");
   			}
   		} else {
   			$("<span class=\"round alert label\">" + data.meta.error_message + "</span>").appendTo("#foundUser");
  		}
   	}
   	
   	function getRecentMedia(userId) {
   		var param = {access_token:access_token};
   		var cmdUrl = 'https://api.instagram.com/v1/users/' + userId + '/media/recent?callback=?';
   		$.getJSON(cmdUrl, param, displayRecentMedia);
   	}
   	
   	function displayRecentMedia(data) {
   		if(data.meta.code == 200) {
   			var nextUrl = data.pagination.next_url;

   			var photos = data.data;
   			if (photos.length > 0) {
   				for(var key in photos) {
   					var photo = photos[key];
   					$('<div id=p' + photo.id + '></div>').addClass('photoWrapper').appendTo('#panel');
   					                    
   					var str = '<img id="' + photo.id + '" src="' + photo.images.thumbnail.url + '" width="100%">';
   					$('<div></div>').addClass('photo').html(str).appendTo('#p' + photo.id);
   					

   					str = 'comments: ' + photo.comments.count;   					
   					$('<span class=\'clickable\' data-photo-id=\'' + photo.id + '\'></span>').html(str).appendTo('#p' + photo.id).click(function() {
//   							Can't fugure out why every click action sends the same object...
//   							displayCommentsForMedia(photo);
//   							
   							getCommentsForMedia($(this).attr('data-photo-id'));
   					});
   					
   					
   					$('#' + photo.id).load(function() {
   						$('#p' + $(this).attr('id')).fadeTo('slow', 1.0);
   					});
   				}
   				if(nextUrl.length > 0) {
   					var prev = "";
   					var next = "<a href=\"#\" id=\"nextLink\"class=\"button\">Next</a>";
   					
   					$("<div class=\"left\"  id=\"pagination\"></div>").appendTo("#panel");
   					$("#pagination").append(next);
   					
   					$("#nextLink").click(function() {
   						alert("nextLink: " + nextUrl);
   					});
   					
   				}
   			} else {
   				//something
   			}
   		} else {
   			//something
   		}
   	}
   	
   	function getCommentsForMedia(id) {
   		//clear
   		$('#mediaComments').empty();
   		$('<h5>' + id + '</h5>').appendTo('#mediaComments');
	   	var param = {access_token:access_token};
  	 	var cmdUrl = 'https://api.instagram.com/v1/media/' + id + '/comments?callback=?';
   		$.getJSON(cmdUrl, param, displayCommentsForMedia);
   	}
   	
   	function displayCommentsForMedia(data) {
			if(data.meta.code == 200) {
				var comments = data.data;
				for (var key in comments) {
					var comment = comments[key];
					var user = comment.from.username;
					var fullname = comment.from.full_name;
					var text = comment.text;
					
					var str = "<div class=\"box\" id=\"" + comment.id + "\"><strong>Comment id: " + comment.id + "</strong>";
					str += "<p><span class=\"title\">Full Name: </span><span class=\"contents\">" + fullname + "</span></p>";
					str += "<p><span class=\"title\">User: </span><span class=\"contents\">" + user + "</span></p>";
					str += "<p><span class=\"title\">Comments: </span><span class=\"contents\">" + text + "</span></p>";
					str += "</div>";
					
//					$("<strong>Comment id: " + comment.id + "</strong>").appendTo('#mediaComments');
//					var str = "<dl class=\"small\" id=\"c" + comment.id + "\"><dt>Full Name:</dt><dd>" + fullname + "</dd>";
//					str += "<dt class=\"next\">User:</dt><dd>" + user + "</dd><dt class=\"next\">Comment:</dt><dd>" + text + "</dd></dl>";
					
					$(str).appendTo("#mediaComments");
				}
			} else {
				//error ocurred...
			}
   	}
   	
		//End scripts
   });
   
   
  </script>
</body>
</html>